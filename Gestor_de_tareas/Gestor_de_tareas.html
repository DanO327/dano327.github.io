<!DOCTYPE html>
<html lang="es" class="transition-colors">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Tareas Avanzado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen transition-colors duration-300">
  <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 w-full max-w-md transition-colors duration-300">
    <!-- Cabecera -->
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">📋 Gestor de Tareas</h1>
      <button 
        onclick="toggleDarkMode()" 
        class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 rounded-lg transition">
        🌙/☀️
      </button>
    </div>

    <!-- Estadísticas solo pendientes -->
    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-4">
      <span>Pendientes: <span id="totalCount">0</span></span>
    </div>

    <!-- Input para añadir tarea -->
    <div class="flex gap-2 mb-2">
      <input 
        type="text" 
        id="taskInput" 
        placeholder="Escribe una tarea..." 
        class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:text-white dark:border-gray-600"
      >
      <select id="prioritySelect" class="p-2 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
        <option value="alta">Alta 🔴</option>
        <option value="media" selected>Media 🟡</option>
        <option value="baja">Baja 🟢</option>
      </select>
      <button 
        onclick="addTask()" 
        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
        Añadir
      </button>
    </div>

    <!-- Buscador -->
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Buscar tareas..." 
      oninput="renderTasks()" 
      class="w-full mb-4 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:text-white dark:border-gray-600"
    >

    <!-- Filtros -->
    <div class="flex justify-center gap-2 mb-4">
      <button onclick="setFilter('pending')" class="filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg">Pendientes</button>
      <button onclick="setFilter('completed')" class="filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg">Completadas</button>
    </div>

    <!-- Lista -->
    <ul id="taskList" class="space-y-2"></ul>
  </div>

  <script>
    const PRIORIDAD_ALTA_ALERTA_DIAS = 3;

    let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
    let currentFilter = "pending";

    const taskInput = document.getElementById("taskInput");
    const prioritySelect = document.getElementById("prioritySelect");
    const taskList = document.getElementById("taskList");
    const totalCount = document.getElementById("totalCount");
    const searchInput = document.getElementById("searchInput");

    // 🌙 Dark Mode
    function loadDarkMode() {
      const theme = localStorage.getItem("theme");
      if (theme === "light") document.documentElement.classList.remove("dark");
      else document.documentElement.classList.add("dark");
    }

    function toggleDarkMode() {
      if (document.documentElement.classList.contains("dark")) {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("theme", "light");
      } else {
        document.documentElement.classList.add("dark");
        localStorage.setItem("theme", "dark");
      }
    }

    // 📊 Stats: solo pendientes
    function updateStats() {
      const pendientes = tasks.filter(t => !t.completed).length;
      totalCount.textContent = pendientes;
    }

    function saveTasks() {
      localStorage.setItem("tasks", JSON.stringify(tasks));
    }

    function addTask() {
      const text = taskInput.value.trim();
      const priority = prioritySelect.value;
      if (text === "") return;

      const now = new Date();
      const timestamp = now.getTime();
      const date = now.toLocaleDateString();
      const time = now.toLocaleTimeString();

      tasks.push({ text, completed: false, priority, date, time, timestamp, completedDate: null, completedTime: null });
      taskInput.value = "";
      renderTasks();
      saveTasks();
    }

    taskInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") addTask();
    });

    function toggleTask(index) {
      const task = tasks[index];
      task.completed = !task.completed;
      const now = new Date();

      if (task.completed) {
        task.completedDate = now.toLocaleDateString();
        task.completedTime = now.toLocaleTimeString();
      } else {
        task.completedDate = null;
        task.completedTime = null;
      }

      saveTasks();
      renderTasks();
    }

    function deleteTask(index) {
      tasks.splice(index, 1);
      saveTasks();
      renderTasks();
    }

    function editTask(index) {
      const newText = prompt("Editar tarea:", tasks[index].text);
      if (newText !== null && newText.trim() !== "") {
        tasks[index].text = newText.trim();
        saveTasks();
        renderTasks();
      }
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.classList.remove("bg-blue-500", "text-white");
        btn.classList.add("bg-gray-200", "dark:bg-gray-700");
      });
      event.target.classList.add("bg-blue-500", "text-white");
      event.target.classList.remove("bg-gray-200", "dark:bg-gray-700");
      renderTasks();
    }

    function getPriorityBadge(priority) {
      if (priority === "alta") return `<span class="px-2 py-1 text-xs rounded-lg bg-red-500 text-white">Prioridad: Alta</span>`;
      if (priority === "media") return `<span class="px-2 py-1 text-xs rounded-lg bg-yellow-500 text-white">Prioridad: Media</span>`;
      return `<span class="px-2 py-1 text-xs rounded-lg bg-green-500 text-white">Prioridad: Baja</span>`;
    }

    function renderTasks() {
      taskList.innerHTML = "";
      const searchText = searchInput.value.trim().toLowerCase();

      // Ordenar tareas: pendientes arriba por prioridad+fecha, completadas abajo por fecha reciente
      tasks.sort((a,b) => {
        const order = { 'alta':1, 'media':2, 'baja':3 };
        if (!a.completed && !b.completed) {
          if (order[a.priority] !== order[b.priority]) return order[a.priority] - order[b.priority];
          return b.timestamp - a.timestamp;
        } else if (a.completed && b.completed) {
          const dateA = new Date(a.completedDate + " " + a.completedTime);
          const dateB = new Date(b.completedDate + " " + b.completedTime);
          return dateB - dateA;
        } else {
          return a.completed ? 1 : -1;
        }
      });

      let filteredTasks = tasks.filter(task => {
        if (currentFilter === "pending") return !task.completed;
        if (currentFilter === "completed") return task.completed;
        return true;
      }).filter(task => task.text.toLowerCase().includes(searchText));

      filteredTasks.forEach(task => {
        const index = tasks.findIndex(t => t.timestamp === task.timestamp);

        // Resaltar prioridad alta pendiente por más de 3 días
        let highlight = "";
        if (!task.completed && task.priority === "alta") {
          const taskDate = new Date(task.timestamp);
          const now = new Date();
          const diffDays = Math.floor((now - taskDate)/(1000*60*60*24));
          if (diffDays >= PRIORIDAD_ALTA_ALERTA_DIAS) {
            highlight = "bg-red-100 dark:bg-red-700";
          }
        }

        const li = document.createElement("li");
        li.className = `flex flex-col p-2 rounded-lg shadow-sm transition-colors ${highlight} ${task.completed ? 'bg-gray-50 dark:bg-gray-700' : ''}`;

        li.innerHTML = `
          <div class="flex items-center gap-2">
            ${getPriorityBadge(task.priority)}
            <span class="task-text cursor-pointer flex-1 ${task.completed ? 'line-through text-gray-400' : 'dark:text-white'}">
              ${task.text}
            </span>
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-300 mt-1 flex justify-between flex-wrap gap-1">
            <span>Creada: ${task.date} ${task.time}</span>
            ${task.completed && task.completedDate ? `<span>Completada: ${task.completedDate} ${task.completedTime}</span>` : ''}
            <div class="flex gap-1">
              <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-lg transition edit-btn">Editar</button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg transition delete-btn">X</button>
            </div>
          </div>
        `;

        // Eventos
        li.querySelector(".task-text").addEventListener("click", () => toggleTask(index));
        li.querySelector(".edit-btn").addEventListener("click", () => editTask(index));
        li.querySelector(".delete-btn").addEventListener("click", () => deleteTask(index));

        taskList.appendChild(li);
      });

      updateStats();
    }

    loadDarkMode();
    renderTasks();
  </script>
</body>
</html>